<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDrive - Cloud Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .spinner { animation: spin 1s linear infinite; }
        .drag-over { border-color: #6366f1 !important; background-color: #eef2ff !important; }
        * { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>

    <script>
        // App State Management
        class AppState {
            constructor() {
                this.currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
                this.users = JSON.parse(localStorage.getItem('users')) || this.initializeDefaultUsers();
                this.files = JSON.parse(localStorage.getItem('files')) || [];
                this.currentView = 'login';
                this.mustResetPassword = false;
                this.currentFolder = null;
            }

            initializeDefaultUsers() {
                const users = [
                    {
                        userId: 'admin',
                        email: 'admin@mydrive.com',
                        password: 'admin123',
                        isAdmin: true,
                        storageUsed: 0,
                        storageLimit: 100 * 1024 * 1024,
                        mustResetPassword: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        userId: 'demo',
                        email: 'demo@mydrive.com',
                        password: 'demo123',
                        isAdmin: false,
                        storageUsed: 0,
                        storageLimit: 50 * 1024 * 1024,
                        mustResetPassword: false,
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('users', JSON.stringify(users));
                return users;
            }

            login(userId, password) {
                const user = this.users.find(u => u.userId === userId && u.password === password);
                if (user) {
                    this.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    if (user.mustResetPassword) {
                        this.mustResetPassword = true;
                        this.currentView = 'reset-password';
                    } else {
                        this.currentView = user.isAdmin ? 'admin' : 'dashboard';
                    }
                    return true;
                }
                return false;
            }

            logout() {
                this.currentUser = null;
                this.currentView = 'login';
                localStorage.removeItem('currentUser');
            }

            resetPassword(newPassword) {
                const userIndex = this.users.findIndex(u => u.userId === this.currentUser.userId);
                if (userIndex !== -1) {
                    this.users[userIndex].password = newPassword;
                    this.users[userIndex].mustResetPassword = false;
                    this.currentUser.mustResetPassword = false;
                    localStorage.setItem('users', JSON.stringify(this.users));
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    this.mustResetPassword = false;
                    this.currentView = this.currentUser.isAdmin ? 'admin' : 'dashboard';
                }
            }

            createUser(userId, email) {
                if (this.users.find(u => u.userId === userId || u.email === email)) {
                    throw new Error('User ID or email already exists');
                }

                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = String(now.getFullYear()).slice(-2);
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const tempPassword = `${day}:${month}:${year}-${hours}:${minutes}`;

                const newUser = {
                    userId,
                    email,
                    password: tempPassword,
                    isAdmin: false,
                    storageUsed: 0,
                    storageLimit: 50 * 1024 * 1024,
                    mustResetPassword: true,
                    createdAt: new Date().toISOString()
                };

                this.users.push(newUser);
                localStorage.setItem('users', JSON.stringify(this.users));
                return tempPassword;
            }

            uploadFile(file, fileName, fileData) {
                const fileObj = {
                    id: Date.now().toString(),
                    userId: this.currentUser.userId,
                    name: fileName,
                    size: file.size,
                    type: file.type,
                    data: fileData,
                    uploadedAt: new Date().toISOString()
                };

                this.files.push(fileObj);
                localStorage.setItem('files', JSON.stringify(this.files));

                const userIndex = this.users.findIndex(u => u.userId === this.currentUser.userId);
                this.users[userIndex].storageUsed += file.size;
                this.currentUser.storageUsed += file.size;
                localStorage.setItem('users', JSON.stringify(this.users));
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
            }

            deleteFile(fileId) {
                const file = this.files.find(f => f.id === fileId);
                if (file) {
                    this.files = this.files.filter(f => f.id !== fileId);
                    localStorage.setItem('files', JSON.stringify(this.files));

                    const userIndex = this.users.findIndex(u => u.userId === this.currentUser.userId);
                    this.users[userIndex].storageUsed -= file.size;
                    this.currentUser.storageUsed -= file.size;
                    localStorage.setItem('users', JSON.stringify(this.users));
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                }
            }

            getUserFiles() {
                return this.files.filter(f => f.userId === this.currentUser.userId);
            }
        }

        const appState = new AppState();

        // UI Components
        function renderApp() {
            const app = document.getElementById('app');

            switch(appState.currentView) {
                case 'login':
                    app.innerHTML = renderLogin();
                    break;
                case 'reset-password':
                    app.innerHTML = renderPasswordReset();
                    break;
                case 'dashboard':
                    app.innerHTML = renderDashboard();
                    setupDashboardListeners();
                    break;
                case 'admin':
                    app.innerHTML = renderAdminPanel();
                    break;
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-indigo-600 mb-2">MYDRIVE</h1>
                            <p class="text-gray-500">Your secure cloud storage</p>
                        </div>

                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
                                <input type="text" id="userId" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
                                    placeholder="Enter your User ID" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="password" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
                                    placeholder="Enter your password" required>
                            </div>

                            <div id="login-error" class="hidden p-3 bg-red-50 text-red-600 rounded-lg text-sm"></div>

                            <button type="submit" 
                                class="w-full py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition">
                                Login
                            </button>
                        </form>

                        <div class="mt-6 p-4 bg-blue-50 rounded-lg text-sm">
                            <p class="font-semibold text-blue-900 mb-2">Demo Credentials:</p>
                            <p class="text-blue-800">Admin: <code class="bg-blue-200 px-2 py-1 rounded">admin / admin123</code></p>
                            <p class="text-blue-800">User: <code class="bg-blue-200 px-2 py-1 rounded">demo / demo123</code></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPasswordReset() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-indigo-600 mb-2">Reset Password</h2>
                            <p class="text-gray-500">You must change your password to continue</p>
                        </div>

                        <form onsubmit="handlePasswordReset(event)" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" id="newPassword" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                    placeholder="At least 8 characters" required minlength="8">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                                <input type="password" id="confirmPassword" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                    placeholder="Re-enter new password" required minlength="8">
                            </div>

                            <div id="reset-error" class="hidden p-3 bg-red-50 text-red-600 rounded-lg text-sm"></div>

                            <button type="submit" 
                                class="w-full py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                                Reset Password
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const storagePercent = (appState.currentUser.storageUsed / appState.currentUser.storageLimit) * 100;
            const storageUsedMB = (appState.currentUser.storageUsed / 1024 / 1024).toFixed(2);
            const storageLimitMB = (appState.currentUser.storageLimit / 1024 / 1024).toFixed(0);
            const userFiles = appState.getUserFiles();

            return `
                <nav class="bg-white shadow-md">
                    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-indigo-600">MYDRIVE</h1>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600">${appState.currentUser.userId}</span>
                            <button onclick="handleLogout()" 
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                Logout
                            </button>
                        </div>
                    </div>
                </nav>

                <div class="max-w-7xl mx-auto p-6">
                    <!-- Storage Quota -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6 fade-in">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">Storage Usage</h3>
                            <span class="text-sm text-gray-500">${storageUsedMB} MB / ${storageLimitMB} MB</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="h-full rounded-full ${storagePercent > 90 ? 'bg-red-500' : storagePercent > 70 ? 'bg-yellow-500' : 'bg-green-500'}" 
                                style="width: ${storagePercent}%"></div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div class="mb-6 fade-in">
                        <div id="dropzone" 
                            class="border-4 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer bg-white hover:border-indigo-400">
                            <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(event)">
                            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="text-lg font-medium text-gray-700 mb-2">Drag & drop a file or click to browse</p>
                            <p class="text-sm text-gray-500">Maximum file size: 5MB</p>
                        </div>
                        <div id="upload-progress" class="hidden mt-4 bg-white rounded-lg p-4 shadow"></div>
                        <div id="upload-error" class="hidden mt-4 p-4 bg-red-50 text-red-600 rounded-lg"></div>
                    </div>

                    <!-- File List -->
                    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">My Files</h2>
                        ${userFiles.length === 0 ? 
                            '<p class="text-center text-gray-500 py-12">No files yet. Upload your first file!</p>' :
                            `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${userFiles.map(file => `
                                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex-1 min-w-0">
                                                <h3 class="font-medium text-gray-900 truncate mb-1">${file.name}</h3>
                                                <p class="text-sm text-gray-500">${(file.size / 1024).toFixed(2)} KB</p>
                                                <p class="text-xs text-gray-400">${new Date(file.uploadedAt).toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="viewFile('${file.id}')" 
                                                class="flex-1 px-3 py-2 bg-indigo-100 text-indigo-700 rounded text-sm font-medium hover:bg-indigo-200">
                                                View
                                            </button>
                                            <button onclick="downloadFile('${file.id}')" 
                                                class="px-3 py-2 bg-green-100 text-green-700 rounded text-sm font-medium hover:bg-green-200">
                                                Download
                                            </button>
                                            <button onclick="deleteFile('${file.id}')" 
                                                class="px-3 py-2 bg-red-100 text-red-700 rounded text-sm font-medium hover:bg-red-200">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>
            `;
        }

        function renderAdminPanel() {
            return `
                <nav class="bg-white shadow-md">
                    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-indigo-600">MYDRIVE</h1>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-600">${appState.currentUser.userId}</span>
                            <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">Admin</span>
                            <button onclick="handleLogout()" 
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                Logout
                            </button>
                        </div>
                    </div>
                </nav>

                <div class="max-w-7xl mx-auto p-6">
                    <!-- Create User Form -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6 fade-in">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Panel</h2>

                        <button onclick="toggleCreateForm()" id="toggleBtn"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 mb-4">
                            Create New User
                        </button>

                        <form id="createUserForm" onsubmit="handleCreateUser(event)" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
                                <input type="text" id="newUserId" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="newEmail" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                            </div>

                            <div id="create-error" class="hidden p-3 bg-red-50 text-red-600 rounded-lg text-sm"></div>
                            <div id="create-success" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg"></div>

                            <button type="submit" 
                                class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                Create User
                            </button>
                        </form>
                    </div>

                    <!-- Users List -->
                    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">All Users</h3>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">User ID</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Email</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Storage Used</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Role</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Created</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appState.users.map(user => `
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="py-3 px-4">${user.userId}</td>
                                            <td class="py-3 px-4">${user.email}</td>
                                            <td class="py-3 px-4">${(user.storageUsed / 1024 / 1024).toFixed(2)} MB</td>
                                            <td class="py-3 px-4">
                                                ${user.isAdmin ? 
                                                    '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-sm">Admin</span>' :
                                                    '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm">User</span>'
                                                }
                                            </td>
                                            <td class="py-3 px-4 text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event Handlers
        function handleLogin(event) {
            event.preventDefault();
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            if (appState.login(userId, password)) {
                renderApp();
            } else {
                errorDiv.textContent = 'Invalid credentials';
                errorDiv.classList.remove('hidden');
            }
        }

        function handlePasswordReset(event) {
            event.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('reset-error');

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters';
                errorDiv.classList.remove('hidden');
                return;
            }

            appState.resetPassword(newPassword);
            renderApp();
        }

        function handleLogout() {
            appState.logout();
            renderApp();
        }

        function setupDashboardListeners() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');

            dropzone.addEventListener('click', () => fileInput.click());

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('drag-over');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
            const errorDiv = document.getElementById('upload-error');
            const progressDiv = document.getElementById('upload-progress');

            errorDiv.classList.add('hidden');

            if (file.size > 5 * 1024 * 1024) {
                errorDiv.textContent = 'File size exceeds 5MB limit';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (appState.currentUser.storageUsed + file.size > appState.currentUser.storageLimit) {
                errorDiv.textContent = 'Storage quota exceeded';
                errorDiv.classList.remove('hidden');
                return;
            }

            progressDiv.innerHTML = `
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Uploading ${file.name}...</span>
                    <span class="text-sm text-gray-500">100%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-indigo-600 h-2 rounded-full" style="width: 100%"></div>
                </div>
            `;
            progressDiv.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                appState.uploadFile(file, file.name, e.target.result);
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    renderApp();
                }, 500);
            };
            reader.readAsDataURL(file);
        }

        function viewFile(fileId) {
            const file = appState.files.find(f => f.id === fileId);
            if (file) {
                if (file.type.startsWith('image/')) {
                    const win = window.open('', '_blank');
                    win.document.write(`<img src="${file.data}" style="max-width:100%; height:auto;">`);
                } else if (file.type === 'application/pdf') {
                    window.open(file.data, '_blank');
                } else {
                    alert('Preview not available for this file type. Please download to view.');
                }
            }
        }

        function downloadFile(fileId) {
            const file = appState.files.find(f => f.id === fileId);
            if (file) {
                const a = document.createElement('a');
                a.href = file.data;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                appState.deleteFile(fileId);
                renderApp();
            }
        }

        function toggleCreateForm() {
            const form = document.getElementById('createUserForm');
            const btn = document.getElementById('toggleBtn');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = 'Hide Form';
            } else {
                form.classList.add('hidden');
                btn.textContent = 'Create New User';
            }
        }

        function handleCreateUser(event) {
            event.preventDefault();
            const userId = document.getElementById('newUserId').value;
            const email = document.getElementById('newEmail').value;
            const errorDiv = document.getElementById('create-error');
            const successDiv = document.getElementById('create-success');

            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            try {
                const tempPassword = appState.createUser(userId, email);
                successDiv.innerHTML = `
                    <p class="text-green-800 font-medium mb-2">User Created Successfully!</p>
                    <p class="text-sm text-green-700">
                        Temporary Password: <span class="font-mono font-bold">${tempPassword}</span>
                    </p>
                    <p class="text-xs text-green-600 mt-1">Share this with the user. They must reset it on first login.</p>
                `;
                successDiv.classList.remove('hidden');
                document.getElementById('newUserId').value = '';
                document.getElementById('newEmail').value = '';

                setTimeout(() => {
                    renderApp();
                }, 3000);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // Initialize App
        renderApp();
    </script>
</body>
</html>
